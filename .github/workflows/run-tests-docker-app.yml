name: Run Tests Against Docker Container

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'tests/challenge/**'
      - '.github/workflows/run-tests-docker-app.yml'

jobs:
  test-docker-app:
    name: Test Fashion Hub Docker Container
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Service container runs alongside the job
    services:
      fashionhub:
        image: pocketaces2/fashionhub-demo-app
        ports:
          - 3000:3000
        options: >-
          --health-cmd="curl -f http://localhost:3000 || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Wait for Fashion Hub app to be ready
        run: |
          echo "Waiting for Fashion Hub app..."
          timeout 30 sh -c 'until curl -f http://localhost:3000; do sleep 2; done'
          echo "Fashion Hub app is ready!"

      - name: Run challenge tests against Docker container
        env:
          BASE_URL: http://localhost:3000
          REPORT_LABEL: docker-container-github-ci
        run: npm test -- tests/challenge/
        continue-on-error: true

      - name: Install markdown-pdf for report generation
        run: npm install -g markdown-pdf

      - name: Generate timestamped PDF report
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          npx markdown-pdf TEST_REPORT.md -o "TEST_REPORT_${TIMESTAMP}_docker-container.pdf"

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-docker
          path: reports/
          retention-days: 30

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-docker
          path: test-results/
          retention-days: 30

      - name: Upload PDF Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pdf-report-docker
          path: TEST_REPORT_*.pdf
          retention-days: 30

      - name: Show Docker logs on failure
        if: failure()
        run: |
          echo "=== Fashion Hub Docker Container Logs ==="
          docker logs $(docker ps -q --filter ancestor=pocketaces2/fashionhub-demo-app)
